{% extends "layout.html" %}

{% block content %}
<script>

 // revenue chart
  async function load_bar_chart() {
    let stock_code = "{{stock['StockCode']}}"
    //document.write('https://stockanalysisapi-xyy5p4vcpa-ew.a.run.app/fundamental?ticker=' + stock_code);
    const response = await fetch('https://stockanalysisapi-xyy5p4vcpa-ew.a.run.app/fundamental?ticker='+stock_code);
    console.log(response);
    const data = await response.json();
    console.log(data);
    length = data.length;
    console.log(length);

    labels = [];
    values_Total_Revenue = [];
    values_EBITDA = [];
    values_PBIT = [];
    values_PBT = [];
    values_Net_Income = [];
    values_EPS = [];
    values_DPS = [];
    values_Payout_ratio = [];

    for (i = 0; i < length; i++) {
      labels.push(data[i].Financial_Year);
      values_Total_Revenue.push(data[i].Total_Revenue);
      values_EBITDA.push(data[i].EBITDA);
      values_PBIT.push(data[i].PBIT);
      values_PBT.push(data[i].PBT);
      values_Net_Income.push(data[i].Net_Income);
      values_EPS.push(data[i].EPS);
      values_DPS.push(data[i].DPS);
      values_Payout_ratio.push(data[i].Payout_ratio);
    }

    //document.write(labels)
    new Chart(document.getElementById("revenue-chart"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: "Revenue in (millions)",
            backgroundColor: ["#3e95cd",
              "#8e5ea2",
              "#3cba9f",
              "#e8c3b9",
              "#c45850"],
            data: values_Total_Revenue
          }
        ]
      },
      options: {
        'height': 300,
        legend: { display: false },
        title: {
          display: true,
          text: 'Revenue Trend'
        }
      }
    });



    new Chart(document.getElementById("net_income-chart"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: "Net Income in (millions)",
            backgroundColor: ["#3e95cd",
              "#8e5ea2",
              "#3cba9f",
              "#e8c3b9",
              "#c45850"],
            data: values_Net_Income
          }
        ]
      },
      options: {
        'height': 300,
        legend: { display: false },
        title: {
          display: true,
          text: 'Net IncomeTrend'
        }
      }
    });




    new Chart(document.getElementById("eps-chart"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: "EPS",
            backgroundColor: ["#3e95cd",
              "#8e5ea2",
              "#3cba9f",
              "#e8c3b9",
              "#c45850"],
            data: values_EPS
          }
        ]
      },
      options: {
        'height': 300,
        legend: { display: false },
        title: {
          display: true,
          text: 'EPS Trend'
        }
      }
    });



    new Chart(document.getElementById("ebita-chart"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: "EBITA Trend",
            backgroundColor: ["#3e95cd",
              "#8e5ea2",
              "#3cba9f",
              "#e8c3b9",
              "#c45850"],
            data: values_EBITDA
          }
        ]
      },
      options: {
        'height': 300,
        legend: { display: false },
        title: {
          display: true,
          text: 'EBITA Trend'
        }
      }
    });
}

load_bar_chart();
</script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load("current", { packages: ["corechart"] });
  google.charts.setOnLoadCallback(drawChart);
  async function drawChart() {

    let stock_code = "{{stock['StockCode']}}"

    const response = await fetch('https://stockanalysisapi-xyy5p4vcpa-ew.a.run.app/twitter?ticker='+stock_code);
    console.log(response);
    const data_twi = await response.json();
    console.log(data_twi);
    length = data_twi.length;
    console.log(length);


    var data_twitter = google.visualization.arrayToDataTable([
      ['row', 'Value'],
      ['Positive', data_twi[0].pos],
      ['Negative', data_twi[0].neg]
    ]);

    var options = {
      'height': 450,
      pieHole: 0.4,
    };

    var chart = new google.visualization.PieChart(document.getElementById('pichart'));
    chart.draw(data_twitter, options);
  }
</script>
<script>
google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(drawClose);

function drawClose() {

var data_close = new google.visualization.DataTable();
data_close.addColumn('number', 'X');
data_close.addColumn('number', 'y');

data_close.addRows([
[0, 0], [1, 10], [2, 23], [3, 17], [4, 18], [5, 9],
[6, 11], [7, 27], [8, 33], [9, 40], [10, 32], [11, 35],
[12, 30], [13, 40], [14, 42], [15, 47], [16, 44], [17, 48],
[18, 52], [19, 54], [20, 42], [21, 55], [22, 56], [23, 57],
[24, 60], [25, 50], [26, 52], [27, 51], [28, 49], [29, 53],
[30, 55], [31, 60], [32, 61], [33, 59], [34, 62], [35, 65],
[36, 62], [37, 58], [38, 55], [39, 61], [40, 64], [41, 65],
[42, 63], [43, 66], [44, 67], [45, 69], [46, 69], [47, 70],
[48, 72], [49, 68], [50, 66], [51, 65], [52, 67], [53, 70],
[54, 71], [55, 72], [56, 73], [57, 75], [58, 70], [59, 68],
[60, 64], [61, 60], [62, 65], [63, 67], [64, 68], [65, 69],
[66, 70], [67, 72], [68, 75], [69, 80]
]);

var options = {
  'height': 450,
  'width': 650,
hAxis: {
title: 'Date'
},
vAxis: {
title: 'Price'
}
};

var chart = new google.visualization.LineChart(document.getElementById('close_chart'));

chart.draw(data_close, options);
}
</script>
<br/>
<br />
<br />
<form method="GET">
<div class="ui fluid action input" style="margin: top 7em;">
  <input list="brow" name="search">
  <datalist id="brow">
    <option value="">
  {% for stock_name in stock_list %}
    <option value="{{stock_name['StockCode']}}">{{stock_name['StockName']}}</option>
  {% endfor %}
  </datalist>
<button class="ui button" type="submit">Search</button>
</div>
</form>
<h2 class="ui dividing header"></h2>
<div class="ui stackable equal width grid">
  <div class="column">
    <h1>{{stock['StockName']}}</h1>
    <div class="ui labeled button" tabindex="0">
      <div class="ui black button">
        <i class="rupee sign"></i> Price
      </div>
      <a class="ui basic black left pointing label">
        {{technical_data[0]['Close']}}
      </a>
    </div>
    <br />
    <span>Symbol : {{stock['StockCode']}}</span>
    <span>Exchange : {{stock['exchange']}}</span>
    <span>Currency : {{stock['Currency']}}</span>
  </div>
  </div>

<br/>
<br />
<div class="ui stackable equal width grid">
  <div class="column">
    <h2>Twitter Sentiments</h2>
    <div id="pichart"></div>
  </div>
  <div class="column">
    <h2>Price forcast</h2>
    <div id="close_chart"></div>
  </div>
</div>

<h2>Fundamental Analysis</h2>
<div class="ui stackable equal width grid">
  <div class="column">
  <canvas id="revenue-chart" height="400" style="height: 400px; display: block; width: 400px;" width="500">
  </canvas>
  </div>
  <div class="column">
<canvas id="net_income-chart" height="400" style="height: 400px; display: block; width: 400px;" width="500">
</canvas>
</canvas>
  </div>
</div>

<div class="ui stackable equal width grid">
  <div class="column">
    <canvas id="eps-chart" height="400" style="height: 400px; display: block; width: 400px;" width="500">
    </canvas>
  </div>
  <div class="column">
    <canvas id="ebita-chart" height="400" style="height: 400px; display: block; width: 400px;" width="500">
    </canvas>
  </div>
</div>

<div class="ui stackable equal width grid">
  <div class="column">
    A
  </div>


  <div class="column">
    B
  </div>
</div>


<h2>Analyst Recommendations </h2>
<table class="ui red table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Action</th>
      <th>Target</th>
      <th>Analyst</th>
    </tr>
  </thead>
  <tbody>
    {% for recommendation in recommendation_list %}
    <tr>
      <td>{{recommendation['date']}}</td>
      <td>{{recommendation['advice']}} </td>
      <td>{{recommendation['target']}}</td>
      <td>{{recommendation['analyst']}}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>


<h2>News </h2>
<table class="ui red table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Title</th>
      <th>Source</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody>
    {% for news in news_list %}
    <tr>
      <td>{{news['date']}}</td>
      <td><div style="word-wrap: break-word;">{{news['title']}}</div>
         </td>
      <td>{{news['source']}}</td>
      {% if news[5] == 'Moneycontrol.com' %}
      <td><a href="https://www.moneycontrol.com{{news[5]}}" target="_blank">More details</a></td>
      {% else %}
      <td><a href="{{news['url']}}" target="_blank">More details</a></td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Technical Data </h2>

<table class="ui red table">

  <thead>
    <tr>
      <th>Period</th>
      <th>SMA</th>
      <th>Indication</th>
    </tr>
  </thead>
  <tbody>
    {% for key in ['ema12','ema21','ema26','ema34','ema55','ema99','ema200'] %}
    <tr>
      <td>{{key}}</td>
      <td>
        {{technical_data[0][key]}}
      </td>
      {% if technical_data[0]['Close'] > technical_data[0][key] %}
      <td>Bullish</td>
      {% else %}
      <td>Bearish</td>
      {% endif %}
    </tr>
    {% endfor %}

  </tbody>
</table>


{% endblock %}
